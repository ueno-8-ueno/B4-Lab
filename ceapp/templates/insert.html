<!doctype html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>Containerlab Chaos Injector</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        .container { margin-bottom: 10px; padding: 5px; border: 1px solid #eee; }
        .link { margin-bottom: 5px; padding-left: 10px; }
        .form-section { margin-top: 20px; padding: 15px; border: 1px solid #ccc; background-color: #f8f8f8; }
        label { display: inline-block; width: 150px; }
        select, input[type="text"] { margin-bottom: 10px; padding: 5px; }
        button { padding: 8px 15px; cursor: pointer; }
        .flash { padding: 10px; margin-top: 10px; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <h1>Containerlab Chaos Injector</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <h2>Detected Topology</h2>
    <h3>Containers:</h3>
    {% if containers %}
        {% for container in containers %}
        <div class="container">{{ container }}</div>
        {% endfor %}
    {% else %}
        <p>No Containerlab containers detected (or Docker error).</p>
    {% endif %}

    <h3>Links (Estimated):</h3>
     <p><i>Note: Interface names for links are not reliably detected in this simple version. Link Down/Up actions might target incorrect interfaces.</i></p>
    {% if links %}
        {% for link in links %}
        <div class="link">{{ link[0] }} <--> {{ link[1] }}</div>
        {% endfor %}
    {% else %}
        <p>No links detected between containers.</p>
    {% endif %}

    <div class="form-section">
        <h2>Inject Fault</h2>
        <form method="post" action="/inject">
            <label for="fault_type">Fault Type:</label>
            <select id="fault_type" name="fault_type" onchange="updateForm()">
                <option value="link_down">Link Down</option>
                <option value="link_up">Link Up</option>
                <option value="node_stop">Node Stop</option>
                <option value="node_start">Node Start</option>
                <option value="node_pause">Node Pause</option>
                <option value="node_unpause">Node Unpause</option>
                <!-- <option value="cpu_stress">CPU Stress</option> -->
                <!-- <option value="bw_limit">Bandwidth Limit</option> -->
            </select>
            <br>

            <div id="link_target" style="display: block;">
                <label for="target_link">Target Link:</label>
                <select id="target_link" name="target_link">
                    {% for link in links %}
                    <option value="{{ link[0] }}|{{ link[1] }}">{{ link[0] }} <--> {{ link[1] }}</option>
                    {% endfor %}
                </select>
                <br>
                <label for="target_interface_link">Interface Name (Guess):</label>
                <input type="text" id="target_interface_link" name="target_interface_link" value="eth1" placeholder="e.g., eth1 (Best Guess)">
                <br>
            </div>

            <div id="node_target" style="display: none;">
                <label for="target_node">Target Node:</label>
                <select id="target_node" name="target_node">
                    {% for container in containers %}
                    <option value="{{ container }}">{{ container }}</option>
                    {% endfor %}
                </select>
                <br>
            </div>

             <!-- Parameters for future faults
             <div id="cpu_params" style="display: none;">
                 <label for="cpu_duration">Duration (seconds):</label>
                 <input type="text" id="cpu_duration" name="cpu_duration" value="60">
             </div>
             <div id="bw_params" style="display: none;">
                 <label for="bw_rate">Rate (e.g., 1mbit):</label>
                 <input type="text" id="bw_rate" name="bw_rate" value="1mbit">
                  <label for="target_interface_bw">Interface Name:</label>
                 <input type="text" id="target_interface_bw" name="target_interface_bw" placeholder="e.g., eth1">
             </div>
             -->

            <button type="submit">Inject Fault</button>
        </form>
    </div>

    <script>
        function updateForm() {
            var faultType = document.getElementById('fault_type').value;
            document.getElementById('link_target').style.display = (faultType === 'link_down' || faultType === 'link_up') ? 'block' : 'none';
            document.getElementById('node_target').style.display = (faultType === 'node_stop' || faultType === 'node_start' || faultType === 'node_pause' || faultType === 'node_unpause' /* || faultType === 'cpu_stress' || faultType === 'bw_limit' */) ? 'block' : 'none';
            // document.getElementById('cpu_params').style.display = (faultType === 'cpu_stress') ? 'block' : 'none';
            // document.getElementById('bw_params').style.display = (faultType === 'bw_limit') ? 'block' : 'none';
        }
        // Initial call to set correct visibility
        updateForm();
    </script>

</body>
</html>